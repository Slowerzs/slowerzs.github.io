<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title> FCSC 2021 - ShuffleMe - Slowerzs&#39; blog </title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="" />
    <meta property="og:site_name" content="Slowerzs&#39; blog" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://blog.slowerzs.net/archive/fcsc-2021-shuffleme/" />
    <meta property="og:title" content="FCSC 2021 - ShuffleMe" />
    <meta property="og:image" content="https://blog.slowerzs.net/images/small-favicon.png" />
    <meta property="og:description" content="" />

    <meta name="twitter:card" content=" summary_large_image" />
    
    <meta name="twitter:title" content="FCSC 2021 - ShuffleMe" />
    <meta name="twitter:description" content="" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@slowerzs">
    <meta name="twitter:image" content="https://blog.slowerzs.net/images/small-favicon.png" />

    <link rel="canonical" href="https://blog.slowerzs.net/archive/fcsc-2021-shuffleme/">

    <link rel="stylesheet" href="https://blog.slowerzs.net/css/bootstrap.min.css" />

    <link rel="stylesheet" href="https://blog.slowerzs.net/css/custom.css" />
    <link rel="stylesheet" href="https://blog.slowerzs.net/css/syntax.css" />

    

    <link rel="shortcut icon"
        href="https://blog.slowerzs.net/images/favicon.png?">

</head>

<body>
    <script>

        window.addEventListener('load', function () {
            hljs.configure({
                ignoreUnescapedHTML: true
            })
            hljs.highlightAll();
        }, true);

        let darkTheme = localStorage.getItem("darkTheme")
        if (darkTheme === null) {
            if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem("darkTheme", true);
                document.getElementById("light-css").setAttribute('disabled', 'true')
                document.getElementById("dark-css").removeAttribute('disabled')
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem("darkTheme", false);
                document.getElementById("dark-css").setAttribute('disabled', 'true')
                document.getElementById("light-css").removeAttribute('disabled')
            }
        } else if (darkTheme === "true") {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById("light-css").setAttribute('disabled', 'true')
            document.getElementById("dark-css").removeAttribute('disabled')
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
            document.getElementById("dark-css").setAttribute('disabled', 'true')
            document.getElementById("light-css").removeAttribute('disabled')
        }

        function switchTheme() {
            let darkTheme = localStorage.getItem("darkTheme");
            if (darkTheme === null) {
                darkTheme = window.matchMedia("(prefers-color-scheme: dark)").matches.toString()
            }

            if (darkTheme === "true") {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem("darkTheme", false);
                document.getElementById("dark-css").setAttribute('disabled', 'true')
                document.getElementById("light-css").removeAttribute('disabled')
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem("darkTheme", true);
                document.getElementById("light-css").setAttribute('disabled', 'true')
                document.getElementById("dark-css").removeAttribute('disabled')
            }

        }
    </script>
    
    <div class="mt-xl header">
    <div class="container">
        <div>
            <div class="row justify-content-center">
                <div class="row">
                    <a href="https://blog.slowerzs.net/">
                        <h1 class="name">Slowerzs&#39; blog</h1>
                    </a>
                    <img id="switcher" onclick="switchTheme()" src="https://blog.slowerzs.net/images/theme-dark.svg" height="32px" width="32px"
                        style="position: absolute; left: 93%; transform: translateX(-93%);" />
                </div>
            </div>

            <div class="row justify-content-center">
                <ul class="nav nav-primary">
                    
                    <li class="nav-item">
                        <a class="nav-link" href="https://blog.slowerzs.net/">
                            
                            Home
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/Slowerzs">
                            
                            Github
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="https://twitter.com/slowerzs">
                            
                            Twitter
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="https://blog.slowerzs.net/archive">
                            
                            Archive
                        </a>
                    </li>
                    
                </ul>
            </div>

        </div>
    </div>
</div>

    <div class="content">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-sm-12 col-lg-8">
                    <h1 class="mx-0 mx-md-4">FCSC 2021 - ShuffleMe</h1>
                    <h6 class="mx-md-4 post-date">May 3, 2021</h6>
                </br>
                    <div class="markdown">
                        
    <h2 id="shuffleme">ShuffleMe</h2>
<p>This challenge was part of the Reverse category, and was worth 200 points.</p>
<blockquote>
<p>Retrouvez les entrées permettant de valider.</p>
</blockquote>
<h2 id="discovery">Discovery</h2>
<p>First, we identify what type of binary this :</p>
<pre tabindex="0"><code class="language-raw" data-lang="raw">$ file shuffleMe 
shuffleMe: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, stripped
</code></pre><p>This is a 64-bit ELF. It is stripped. Let&rsquo;s try running the binary :</p>
<pre tabindex="0"><code class="language-raw" data-lang="raw">$ ./shuffleMe 
Usage: ./shuffleMe &lt;secret&gt;
$ ./shuffleMe 1
bobcat
Nope.
</code></pre><p>The program expects a secret as a first argument, then waits for input through stdin. Afterwards, it simply says <code>Nope.</code>
Let&rsquo;s have a look at the assembly of the program - starting with the main function.</p>
<pre tabindex="0"><code>            0x00401172      55             push rbp
            0x00401173      4889e5         mov rbp, rsp
            0x00401176      4883ec70       sub rsp, 0x70
            0x0040117a      897d9c         mov dword [rbp - 0x64], edi
            0x0040117d      48897590       mov qword [rbp - 0x70], rsi
            0x00401181      837d9c02       cmp dword [rbp - 0x64], 2
        ┌─&lt; 0x00401185      742a           je 0x4011b1
        │   0x00401187      488b4590       mov rax, qword [rbp - 0x70]
        │   0x0040118b      488b10         mov rdx, qword [rax]
        │   0x0040118e      488b05cb4e00.  mov rax, qword [obj.stderr] ; [0x406060:8]=0
        │   0x00401195      be04404000     mov esi, str.Usage:__s__secret ; 0x404004 ; &#34;Usage: %s &lt;secret&gt;\n&#34;
        │   0x0040119a      4889c7         mov rdi, rax
        │   0x0040119d      b800000000     mov eax, 0
        │   0x004011a2      e8a9feffff     call sym.imp.fprintf
        │   0x004011a7      bf01000000     mov edi, 1
        │   0x004011ac      e8cffeffff     call sym.imp.exit
        └─&gt; 0x004011b1      488b4590       mov rax, qword [rbp - 0x70]
            0x004011b5      4883c008       add rax, 8
            0x004011b9      488b00         mov rax, qword [rax]
            0x004011bc      4889c7         mov rdi, rax
            0x004011bf      e89cfeffff     call sym.imp.atoi
            0x004011c4      8945fc         mov dword [rbp - 4], eax
            0x004011c7      488d45a0       lea rax, [rbp - 0x60]
            0x004011cb      ba50000000     mov edx, 0x50               ; &#39;P&#39; ; 80
            0x004011d0      be00000000     mov esi, 0
            0x004011d5      4889c7         mov rdi, rax
            0x004011d8      e863feffff     call sym.imp.memset
            0x004011dd      488d45a0       lea rax, [rbp - 0x60]
            0x004011e1      4889c6         mov rsi, rax
            0x004011e4      bf18404000     mov edi, str.70s            ; 0x404018 ; &#34;%70s&#34;
            0x004011e9      b800000000     mov eax, 0
            0x004011ee      e87dfeffff     call sym.imp.__isoc99_scanf
            0x004011f3      8b55fc         mov edx, dword [rbp - 4]
            0x004011f6      488d45a0       lea rax, [rbp - 0x60]
            0x004011fa      4889d6         mov rsi, rdx
            0x004011fd      4889c7         mov rdi, rax
            0x00401200      e82b000000     call 0x401230
            0x00401205      488945f0       mov qword [rbp - 0x10], rax
            0x00401209      48817df00000.  cmp qword [rbp - 0x10], 0x460000
        ┌─&lt; 0x00401211      750c           jne 0x40121f
        │   0x00401213      bf1d404000     mov edi, str.Yay            ; 0x40401d ; &#34;Yay!&#34;
        │   0x00401218      e813feffff     call sym.imp.puts
       ┌──&lt; 0x0040121d      eb0a           jmp 0x401229
       │└─&gt; 0x0040121f      bf22404000     mov edi, str.Nope.          ; 0x404022 ; &#34;Nope.&#34;
       │    0x00401224      e807feffff     call sym.imp.puts
       └──&gt; 0x00401229      b800000000     mov eax, 0
            0x0040122e      c9             leave
            0x0040122f      c3             ret
</code></pre><p>The code of this function is fairly straight forward : it checks that <code>argc</code> is equal to <code>2</code>, else, it prints the usage and exits.
If we do provide an argument, it calls <code>atoi</code> on our argument, so we know it probably expects an integer as argument.
Afterwards, it zeroes out a stack buffer, and calls <code>scanf(&quot;%70s&quot;, stack_buffer)</code>. Knowing that most challenge flags are 70 characters long, I suspect this expects the flag to be inputed.
Finally, it calls a function at <code>0x401230</code>, with our stack buffer and the integer as arguments. If the return value is <code>0x460000</code>, it prints <code>Yay!</code>, otherwise <code>Nope.</code>. So we know the real magic happens in this function, the goal is to get this function to return <code>0x460000</code></p>
<h2 id="the-main-logic">The main logic</h2>
<p>Let&rsquo;s have a look at the function at <code>0x401230</code>.</p>
<pre tabindex="0"><code class="language-x86asm" data-lang="x86asm">            0x00401230      4831db         xor rbx, rbx
            0x00401233      4d31c9         xor r9, r9
            0x00401236      4d31db         xor r11, r11
            0x00401239      49c7c4330000.  mov r12, 0x33               ; &#39;3&#39; ; 51
            0x00401240      e800000000     call 0x401245
            0x00401245      4158           pop r8
            0x00401247      4983c038       add r8, 0x38                ; 56
     ┌┌┌┌─&gt; 0x0040124b      50             push rax
     ╎╎╎╎   0x0040124c      4889f0         mov rax, rsi
     ╎╎╎╎   0x0040124f      48c7c1b50000.  mov rcx, 0xb5               ; 181
     ╎╎╎╎   0x00401256      48f7e1         mul rcx
     ╎╎╎╎   0x00401259      4805d9000000   add rax, 0xd9               ; 217
     ╎╎╎╎   0x0040125f      48c7c1000200.  mov rcx, 0x200              ; 512
     ╎╎╎╎   0x00401266      48f7f1         div rcx
     ╎╎╎╎   0x00401269      4889d6         mov rsi, rdx
     ╎╎╎╎   0x0040126c      4889f1         mov rcx, rsi
     ╎╎╎╎   0x0040126f      48c1e104       shl rcx, 4
     ╎╎╎╎   0x00401273      4c01c1         add rcx, r8
     ╎╎╎╎   0x00401276      58             pop rax
     ╎╎╎╎   0x00401277      4983eb07       sub r11, 7
     ╎╎╎╎   0x0040127b      ffe1           jmp rcx
     ╎╎╎╎   0x0040127d      4d01d1         add r9, r10
     ╎╎╎╎   0x00401280      90             nop
     ╎╎╎╎   0x00401281      90             nop
     ╎╎╎╎   0x00401282      90             nop
     ╎╎╎╎   0x00401283      90             nop
     ╎╎╎╎   0x00401284      90             nop
     ╎╎╎╎   0x00401285      90             nop
     ╎╎╎╎   0x00401286      90             nop
     ╎╎╎╎   0x00401287      90             nop
     └────&lt; 0x00401288      e9beffffff     jmp 0x40124b
      ╎╎╎   0x0040128d      4909d9         or r9, rbx
      ╎╎╎   0x00401290      90             nop
      ╎╎╎   0x00401291      90             nop
      ╎╎╎   0x00401292      90             nop
      ╎╎╎   0x00401293      90             nop
      ╎╎╎   0x00401294      90             nop
      ╎╎╎   0x00401295      90             nop
      ╎╎╎   0x00401296      90             nop
      ╎╎╎   0x00401297      90             nop
      └───&lt; 0x00401298      e9aeffffff     jmp 0x40124b
       ╎╎   0x0040129d      4831f3         xor rbx, rsi
       ╎╎   0x004012a0      90             nop
       ╎╎   0x004012a1      90             nop
       ╎╎   0x004012a2      90             nop
...
</code></pre><p>This function seems atypical : it is very long - we can&rsquo;t even see a <code>ret</code>. Let&rsquo;s try to understand the prologue.
Firstly, it clears out <code>rbx</code>, <code>r9</code> and <code>r11</code>, and sets <code>r12</code> to <code>0x33</code>. Then, it <code>call 0x401245</code>. This is the address imediately after ! Why does the program do that ? The first instruction after the <code>call</code> is a <code>pop r8</code>, and when a <code>call</code> occurs, it pushes the return address onto the stack, which there is immediately <code>pop</code>&rsquo;d in <code>r8</code>. This is simply a way of setting <code>r8</code> to <code>0x401245</code>.</p>
<p>Next, it adds <code>0x38</code> to <code>r8</code>, which now contains <code>0x40127d</code>. Note that this is the address of slightly later in the function.</p>
<p>Afterwards, it saves <code>rax</code> by <code>push</code>&lsquo;ing it, then performs some math of <code>rsi</code>, which is the 2nd argument passed to our function, the argument we passed through <code>argv</code>.
This is the equivalent python code to the calculations :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">rsi</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0xd9</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0xb5</span> <span class="o">*</span> <span class="n">rsi</span><span class="p">))</span> <span class="o">%</span> <span class="mh">0x200</span><span class="p">)</span>
</span></span></code></pre></div><p>It restores <code>rax</code>, then adds our calculated <code>rsi &lt;&lt; 4</code> to the previously calculated address in <code>rcx</code>, substracts <code>7</code> to <code>r11</code>, and finally jumps to <code>rcx</code>.
What this does is calculate an address to which it jumps, and the possibles addresses are right after : it jumps to one instruction followed by a number of <code>nop</code>, then jumps back to the top, calculate a new <code>rsi</code> value, jumps somewhere else, etc&hellip; It is some sort of loop, and the our <code>argv</code> is what determines the seed for the loop.
So how do we figure out the correct value for our <code>argv</code> ?</p>
<h2 id="finding-the-correct-argument">Finding the correct argument</h2>
<p>It is not easy to follows the many jumps the program does, so I wrote a python script to print out the first instruction in the loop based, using the <code>capstone</code> library.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">capstone</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">base</span> <span class="o">=</span> <span class="mh">0x40127d</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;shuffleMe&#34;</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">md</span> <span class="o">=</span> <span class="n">Cs</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_first_instructions</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#Let&#39;s print the first 25 instructions</span>
</span></span><span class="line"><span class="cl">        <span class="n">seed</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0xd9</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0xb5</span> <span class="o">*</span> <span class="n">seed</span><span class="p">))</span> <span class="o">%</span> <span class="mh">0x200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">addr</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">seed</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">CODE</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0x400000</span> <span class="p">:</span> <span class="n">addr</span><span class="o">+</span><span class="mi">20</span> <span class="o">-</span> <span class="mh">0x400000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#We just want one instruction, but we don&#39;t know how many bytes it is, so we take more and break after the first instruction printed out</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">dis</span> <span class="ow">in</span> <span class="n">md</span><span class="o">.</span><span class="n">disasm</span><span class="p">(</span><span class="n">CODE</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x</span><span class="si">%x</span><span class="s2">:</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span><span class="p">(</span><span class="n">dis</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">dis</span><span class="o">.</span><span class="n">mnemonic</span><span class="p">,</span> <span class="n">dis</span><span class="o">.</span><span class="n">op_str</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x200</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;---------</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2">---------&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">print_first_instructions</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span></code></pre></div><p>Let&rsquo;s have a look at the output for the first values :</p>
<pre tabindex="0"><code class="language-x86asm" data-lang="x86asm">---------0x0---------                                                                                                                                                     
0x40200d:       add     r11, r12                                                                                                                                        
0x4016dd:       mov     bl, byte ptr [rdi + 0xa]                                                                                                                        
0x4017ed:       mov     bh, bl                                                                                                                                          
0x40183d:       xor     bx, 0x6783                                                                                                                                      
0x4030cd:       xor     rbx, rsi                                                                                                                                        
0x402e9d:       or      r9, rbx                                                                                                                                         
0x4022ad:       add     r9, r10                                                                                                                                         
0x4031fd:       add     r11, r12                                                                                                                                        
0x40258d:       mov     bl, byte ptr [rdi + 0xb]                                                                                                                        
0x401a5d:       mov     bh, bl                                                                                                                                          
0x40316d:       xor     bx, 0x64b0                                                                                                                                      
0x401fbd:       xor     rbx, rsi                                                                                                                                        
0x401e4d:       or      r9, rbx                                                                                                                                         
0x401a1d:       add     r9, r10                                                                                                                                         
0x40242d:       add     r11, r12                                                                                                                                        
0x40217d:       mov     bl, byte ptr [rdi + 0xc]                                                                                                                        
0x401b0d:       mov     bh, bl                                                                                                                                          
0x402ddd:       xor     bx, 0x64e3                                                                                                                                      
0x401aed:       xor     rbx, rsi                                                                                                                                        
0x40173d:       or      r9, rbx                                                                                                                                         
0x401bcd:       add     r9, r10                                                                                                                                         
0x40159d:       add     r11, r12                                                                                                                                        
0x4015ad:       mov     bl, byte ptr [rdi + 0xd]                                                                                                                        
0x4020fd:       mov     bh, bl                                                                                                                                          
0x40208d:       xor     bx, 0x35da                                                                                                                                      
---------0x1---------                                                                                                                                                     
0x402b5d:       add     r9, r10
0x40166d:       add     r11, r12
0x4028bd:       mov     bl, byte ptr [rdi + 0x40]
0x401b4d:       mov     bh, bl
0x401b1d:       xor     bx, 0x355e
0x40192d:       xor     rbx, rsi
0x401a7d:       or      r9, rbx
0x40280d:       add     r9, r10
0x401edd:       add     r11, r12
0x401fed:       mov     bl, byte ptr [rdi + 0x41]
0x40203d:       mov     bh, bl
0x4018cd:       xor     bx, 0x3072
0x40169d:       xor     rbx, rsi
0x402aad:       or      r9, rbx
0x4019fd:       add     r9, r10
0x402d8d:       add     r11, r12
0x40225d:       mov     bl, byte ptr [rdi + 0x42]
0x40196d:       mov     bh, bl
0x4027bd:       xor     bx, 0x3804
0x40264d:       xor     rbx, rsi
0x40221d:       or      r9, rbx
0x402c2d:       add     r9, r10
0x40297d:       add     r11, r12
0x40230d:       mov     bl, byte ptr [rdi + 0x43]
0x4015dd:       mov     bh, bl
---------0x2---------
0x4016ad:       or      r9, rbx
0x4015fd:       add     r9, r10
0x40198d:       add     r11, r12
0x401e5d:       mov     bl, byte ptr [rdi + 2]
0x40256d:       mov     bh, bl
0x4023bd:       xor     bx, 0x52ae
0x40324d:       xor     rbx, rsi
0x401e1d:       or      r9, rbx
0x40182d:       add     r9, r10
0x40257d:       add     r11, r12
0x402f0d:       mov     bl, byte ptr [rdi + 3]
...
</code></pre><p>The first thing that we notice is that in each case, it takes on byte from <code>[rdi + x]</code>, and perform some <code>xor</code> operations on it. Remember that in <code>rdi</code> we have our first argument to the function, the address of our input. So it is taking one byte from our input. More so, it seems to do it in an incremental manner, but starts at different offset each time. So, to find out the correct argument, we probably have to find on which starts to take values from <code>[rdi + 0]</code>.</p>
<p>It is the case for <code>0xc1</code> !</p>
<pre tabindex="0"><code>---------0xc1---------
0x40275d:       shl     r10, 8
0x40226d:       dec     rax
0x4024bd:       mov     bl, byte ptr [rdi]
0x40274d:       mov     bh, bl
0x40171d:       xor     bx, 0x476d
0x40252d:       xor     rbx, rsi
0x40167d:       or      r9, rbx
0x40140d:       add     r9, r10
0x401add:       add     r11, r12
0x402bed:       mov     bl, byte ptr [rdi + 1]
0x401c3d:       mov     bh, bl
0x4024cd:       xor     bx, 0x4341
0x40129d:       xor     rbx, rsi
0x4016ad:       or      r9, rbx
0x4015fd:       add     r9, r10
0x40198d:       add     r11, r12
0x401e5d:       mov     bl, byte ptr [rdi + 2]
0x40256d:       mov     bh, bl
0x4023bd:       xor     bx, 0x52ae
0x40324d:       xor     rbx, rsi
0x401e1d:       or      r9, rbx
0x40182d:       add     r9, r10
0x40257d:       add     r11, r12
0x402f0d:       mov     bl, byte ptr [rdi + 3]
</code></pre><p>Now we have our value for the argument, time to figure out how it checks the flag.</p>
<h2 id="finding-the-correct-input">Finding the correct input</h2>
<p>Let&rsquo;s focus on the instructions following the <code>mov bl, byte ptr [rdi + x]</code>, after that we always have a <code>mov bh, bl</code>, so both of the lower bytes of rbx are set to the byte of our input that we are currently checking.
Next, it performs a <code>xor bx, 0xXXYY</code> followed by a <code>xor rbx, rsi</code>. First, let&rsquo;s imagine assume that our goal is to set <code>rbx</code> to <code>0</code>, which would be the simplest way to check our input - without checking what it does to <code>r9</code>, we can come back to it if needed.
Then, because we know <code>rsi</code> value easily - it is the <code>seed</code> variable in our script, we can easily figure out each character by performing a simple <code>0xXXYY ^ seed</code>.</p>
<p>Let&rsquo;s modify our python script to this :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">capstone</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">base</span> <span class="o">=</span> <span class="mh">0x40127d</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;shuffleMe&#34;</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">md</span> <span class="o">=</span> <span class="n">Cs</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_flag</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">seed</span> <span class="o">=</span> <span class="mh">0xc1</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#Let&#39;s print the first 25 instructions</span>
</span></span><span class="line"><span class="cl">        <span class="n">seed</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0xd9</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0xb5</span> <span class="o">*</span> <span class="n">seed</span><span class="p">))</span> <span class="o">%</span> <span class="mh">0x200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">addr</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">seed</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">CODE</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0x400000</span> <span class="p">:</span> <span class="n">addr</span><span class="o">+</span><span class="mi">20</span> <span class="o">-</span> <span class="mh">0x400000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#We just want one instruction, but we don&#39;t know how many bytes it is, so we take more and break after the first instruction printed out</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">dis</span> <span class="ow">in</span> <span class="n">md</span><span class="o">.</span><span class="n">disasm</span><span class="p">(</span><span class="n">CODE</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;xor&#34;</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">mnemonic</span> <span class="ow">and</span> <span class="s2">&#34;bx&#34;</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">op_str</span> <span class="ow">and</span> <span class="s2">&#34;rsi&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">op_str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dis</span><span class="o">.</span><span class="n">op_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;, &#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;rsi&#34;</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">op_str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">ch</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">hex</span><span class="p">((</span><span class="n">val</span> <span class="o">^</span> <span class="n">seed</span><span class="p">))[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1">#We do this because the result is 2 bytes long, twice the same byte and we just want one</span>
</span></span><span class="line"><span class="cl">                <span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span> <span class="o">+</span> <span class="n">ch</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&#34;}&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">get_flag</span><span class="p">()</span>
</span></span></code></pre></div><p>With this, we get the flag : <code>FCSC{af22cfdd46bfc8105cb28e04988f904049dd60be1245718ffef5b9bbf9b509d5}</code></p>
<p>We did not check how it calculates the return value to get <code>0x460000</code>, but that was efficient.</p>



                    </div>
                </div>
            </div>
        </div>
    </div>

    


    

    

    <div id="modal" class="modal">
        <img id="modal-content" class="modal-content">
    </div>
    <script>

        if (typeof screen.orientation !== 'undefined') {
            
            var modal = document.getElementById('modal');

            modal.addEventListener('click', function (e) {
                if (e.target === e.currentTarget) {
                    modal.style.display = "none";
                    document.body.style.overflowY = "visible"
                }
            });
            document.addEventListener('keydown', function (e) {
                if (e.key === "Escape") {
                    modal.style.display = "none";
                    document.body.style.overflowY = "visible"
                }
            })

            document.addEventListener('click', function (e) {
                if (e.target.parentElement.parentElement.className.indexOf('figure') !== -1) {
                    var img = e.target;
                    var modalImg = document.getElementById("modal-content");
                    document.body.style.overflowY = "hidden"
                    modal.style.display = "flex";
                    modalImg.src = img.src;
                }
            });

        }


    </script>

    

</body>

</html>